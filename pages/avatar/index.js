(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/avatar/index"],{"1d9c":function(e,t,n){"use strict";n.r(t);var a=n("5d90"),i=n.n(a);for(var r in a)"default"!==r&&function(e){n.d(t,e,(function(){return a[e]}))}(r);t["default"]=i.a},"3bdd":function(e,t,n){"use strict";(function(e){n("1d89");a(n("66fd"));var t=a(n("e217"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},"412e":function(e,t,n){},"5d90":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=d(n("a34a")),i=d(n("e50a")),r=n("7ddb"),o=d(n("1427")),s=n("05ac"),c=n("74a7"),u=n("937d");function d(e){return e&&e.__esModule?e:{default:e}}function f(e,t,n,a,i,r,o){try{var s=e[r](o),c=s.value}catch(u){return void n(u)}s.done?t(c):Promise.resolve(c).then(a,i)}function g(e){return function(){var t=this,n=arguments;return new Promise((function(a,i){var r=e.apply(t,n);function o(e){f(r,a,i,o,s,"next",e)}function s(e){f(r,a,i,o,s,"throw",e)}o(void 0)}))}}var l=function(){n.e("components/tabbar/index").then(function(){return resolve(n("ad47"))}.bind(null,n)).catch(n.oe)},h={components:{tabbar:l},data:function(){return{store:[],inspire:[],poster:{},posterImage:"",canvasId:"default_PosterCanvasId",userInfo:"",code:"",avatarImage:e.getStorageSync("avatar_image"),currentImage:{},currentIndex:0,imageList:[],categoriesList:[],category:[],shareInfo:{},on:!0}},onLoad:function(){var e=this;e.getCategoriesList(),e.AudioPlay(),e.getStore(),e.getUser()},onUnload:function(){var e=this;e.muteBgMusic=!e.muteBgMusic,e.muteBgMusic&&e.$music.playBgm({mute:!0})},onShareAppMessage:function(){var e=this;return{title:e.store.share.title,desc:e.store.share.desc,path:"/pages/avatar/index?referee_id="+ +(e.userInfo?e.userInfo.user_id:"")}},onShareTimeline:function(){var e=this;return{title:e.store.share.title,desc:e.store.share.desc,path:"/pages/avatar/index?referee_id="+(e.userInfo?e.userInfo.user_id:"")}},methods:{getUser:function(){var e=this;return g(a.default.mark((function t(){var n;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e,t.next=3,(0,u.detail)({}).then((function(e){e.userInfo&&(n.userInfo=e.userInfo)})).catch((function(e){console.log(e)}));case 3:case"end":return t.stop()}}),t)})))()},getStore:function(){var e=this;return g(a.default.mark((function t(){var n;return a.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n=e,t.next=3,(0,r.store)({}).then((function(e){n.store=e.store,n.inspire=e.inspire,e.inspire.ins_ad&&(o.default.interstitial.load(e.inspire.ins_ad),setTimeout((function(){o.default.interstitial.show()}),1e3))})).catch((function(e){console.log(e)}));case 3:case"end":return t.stop()}}),t)})))()},onStopAudio:function(){var e=this;e.muteBgMusic=!e.muteBgMusic,console.log(e.muteBgMusic,e.muteBgMusic?"已关闭音乐####":"已开启音乐####"),e.muteBgMusic?e.$music.playBgm({mute:!0}):e.$music.playBgm({mute:!1})},AudioPlay:function(){var e=this;e.$music.playBgm({mute:!1})},getCategoriesList:function(){var t=this;e.showLoading({title:"加载中",mask:!0}),(0,c.category)({}).then((function(n){e.hideLoading(),t.category=n.category,t.category.length>0?(t.$set(t.category[0],"selected",!0),t.getImagesList(t.category[0].category_id)):t.category=[]})).catch((function(t){e.hideLoading()}))},getImagesList:function(t,n){var a=this;e.showLoading({title:"加载中",mask:!0}),(0,c.frame)({category_id:t}).then((function(t){a.imageList=t.avatar.data,a.currentImage=n<0?a.imageList[a.imageList.length-1]:a.imageList[0],e.hideLoading()})).catch((function(t){e.hideLoading()}))},switchCategory:function(e,t){var n=this,a=n.category.filter((function(e){return e.selected}));a&&a.length>0&&(a[0].selected=!1),n.$set(e,"selected",!0),n.getImagesList(e.category_id,t)},switchAvatar:function(e){var t=this;o.default.interstitial.show();var n=this.imageList.findIndex((function(e){return e._id===t.currentImage._id}));if(e>0&&n<this.imageList.length-1||e<0&&n>0)n+=e,this.currentImage=this.imageList[n];else{var a=this.category.findIndex((function(e){return e.selected}));a+=e,this.category[a]&&this.category[a]._id&&this.switchCategory(this.category[a],e)}},imageClick:function(e){this.currentImage=e},showSwitch:function(e){var t=this,n=this.category.findIndex((function(e){return e.selected})),a=this.imageList.findIndex((function(e){return e._id===t.currentImage._id})),i=e<0&&n<=0&&a<=0||e>0&&n>=this.category.length-1&&a>=this.imageList.length-1;return!i},getWeixinCode:function(){return new Promise((function(t,n){e.login({provider:"weixin",success:function(e){t(e.code)},fail:function(e){n(new Error("微信登录失败"))}})}))},shareFc:function(){var t=this;return g(a.default.mark((function n(){var r;return a.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.avatarImage){n.next=3;break}return e.showToast({title:"请先获取头像",icon:"none"}),n.abrupt("return");case 3:return n.prev=3,e.showLoading({title:"加载中",mask:!0}),i.default.log("准备生成:"+new Date),n.next=8,(0,s.getSharePoster)({_this:t,type:"testShareType",formData:{},backgroundImage:t.avatarImage,posterCanvasId:t.canvasId,delayTimeScale:20,drawArray:function(e){var n=e.bgObj;e.type,e.bgScale;return new Promise((function(e,a){e([{type:"image",url:t.currentImage.image.file_path,dx:0,dy:0,infoCallBack:function(e){return{dWidth:n.width,dHeight:n.height}}}])}))},setCanvasWH:function(e){var n=e.bgObj;e.type,e.bgScale;t.poster=n}});case 8:r=n.sent,i.default.log("海报生成成功, 时间:"+new Date+"， 临时路径: "+r.poster.tempFilePath),t.posterImage=r.poster.tempFilePath,t.savefile(),e.hideLoading(),n.next=20;break;case 15:n.prev=15,n.t0=n["catch"](3),e.hideLoading(),i.default.hideLoading(),i.default.showToast(JSON.stringify(n.t0));case 20:case"end":return n.stop()}}),n,null,[[3,15]])})))()},savefile:function(){var t=this;e.getSetting({success:function(n){n.authSetting["scope.writePhotosAlbum"]?t.saveImgToLocal():e.authorize({scope:"scope.writePhotosAlbum",success:function(){t.saveImgToLocal()},fail:function(t){e.hideLoading(),wx.showModal({content:"检测到您没打开下载图片功能权限，是否去设置打开？",confirmText:"确认",cancelText:"取消",success:function(e){e.confirm&&wx.openSetting()}})}})}})},saveImgToLocal:function(t){var n=this;e.saveImageToPhotosAlbum({filePath:n.posterImage,success:function(){n.saveImageInfo(),e.setStorageSync("currentImage",n.posterImage)},fail:function(){e.hideLoading(),e.showToast({title:"保存失败",icon:"none"})}})},saveImageInfo:function(){o.default.interstitial.show(),e.showToast({title:"头像已保存",icon:"none"})},getUserProfile:function(t){var n=this;return g(a.default.mark((function i(){var r;return a.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:r=n,e.getUserProfile({desc:"获取您的头像信息",success:function(n){var a={code:r.code,signature:n.signature,encrypted_data:n.encryptedData,iv:n.iv,userInfo:n.userInfo},i=a.userInfo.avatarUrl;"createImages"===t&&(r.avatarImage=i.substring(0,i.lastIndexOf("/")+1)+"0",e.setStorageSync("avatar_image",r.avatarImage))},fail:function(e){}});case 2:case"end":return a.stop()}}),i)})))()}}};t.default=h}).call(this,n("543d")["default"])},c8b8:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a}));var a={uEmpty:function(){return Promise.all([n.e("common/vendor"),n.e("node-modules/uview-ui/components/u-empty/u-empty")]).then(n.bind(null,"e6e6"))}},i=function(){var e=this,t=e.$createElement,n=(e._self._c,e.showSwitch(-1)),a=e.showSwitch(1);e.$mp.data=Object.assign({},{$root:{m0:n,m1:a}})},r=[]},d90f:function(e,t,n){"use strict";var a=n("412e"),i=n.n(a);i.a},e217:function(e,t,n){"use strict";n.r(t);var a=n("c8b8"),i=n("1d9c");for(var r in i)"default"!==r&&function(e){n.d(t,e,(function(){return i[e]}))}(r);n("d90f");var o,s=n("f0c5"),c=Object(s["a"])(i["default"],a["b"],a["c"],!1,null,"29c51cad",null,!1,a["a"],o);t["default"]=c.exports}},[["3bdd","common/runtime","common/vendor"]]]);